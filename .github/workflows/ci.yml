name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  unit:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      name: CI

      on:
        push:
          branches: [ main ]
        pull_request:
          branches: [ main ]

      jobs:
        unit:
          name: Unit tests
          runs-on: ubuntu-latest
          steps:
            - uses: actions/checkout@v4
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.11'
            - name: Cache pip
              uses: actions/cache@v4
              with:
                path: ~/.cache/pip
                key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
                restore-keys: |
                  ${{ runner.os }}-pip-
            - name: Install dependencies
              run: |
                python -m venv .venv
                ./.venv/bin/python -m pip install -e '.[dev]'
            - name: Run unit tests (skip local-only Playwright tests)
              run: |
                set -o pipefail
                # Skip tests marked with @pytest.mark.local so Playwright/browser tests are never executed in CI
                ./.venv/bin/python -m pytest -q -m "not local" 2>&1 | tee pytest-output.txt
                RC=${PIPESTATUS[0]}
                exit $RC
            - name: List local-only tests (for visibility)
              run: |
                # Use a small helper script to collect tests; avoids embedding scripts in YAML
                ./.venv/bin/python ci/list_local_tests.py
            - name: Sanitize pytest output
              name: CI

              on:
                push:
                  branches: [ main ]
                pull_request:
                  branches: [ main ]

              jobs:
                unit:
                  runs-on: ubuntu-latest
                  steps:
                    - uses: actions/checkout@v4
                    - name: Set up Python
                      uses: actions/setup-python@v4
                      with:
                        python-version: '3.11'
                    - name: Install dependencies and run tests (skip local)
                      run: |
                        python -m venv .venv
                        ./.venv/bin/python -m pip install -e '.[dev]'
                        set -o pipefail
                        ./.venv/bin/python -m pytest -q -m "not local" 2>&1 | tee pytest-output.txt
                        RC=${PIPESTATUS[0]}
                        exit $RC
